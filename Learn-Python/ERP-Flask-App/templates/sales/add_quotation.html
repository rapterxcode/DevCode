{% extends "base.html" %}

{% block title %}Add Quotation - ERP System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Create Quotation</h1>
    <a href="{{ url_for('quotations') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to List
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="customer_id" class="form-label">Customer / ลูกค้า</label>
                    <select class="form-select" id="customer_id" name="customer_id" required>
                        <option value="">Select Customer / เลือกลูกค้า</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="quote_date" class="form-label">Quote Date / วันที่เสนอราคา</label>
                    <input type="date" class="form-control" id="quote_date" name="quote_date" 
                           value="{{ moment().format('YYYY-MM-DD') }}" required>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="valid_until" class="form-label">Valid Until / ใช้ได้ถึง</label>
                    <input type="date" class="form-control" id="valid_until" name="valid_until">
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="prepared_by" class="form-label">Prepared By / จัดทำโดย</label>
                    <input type="text" class="form-control" id="prepared_by" name="prepared_by" 
                           value="{{ session.username }}" required>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="discount" class="form-label">Discount (%) / ส่วนลด (%)</label>
                    <input type="number" class="form-control" id="discount" name="discount" 
                           step="0.01" min="0" max="100" value="0">
                </div>
            </div>
            
            <div class="mb-3">
                <label for="notes" class="form-label">Notes / หมายเหตุ</label>
                <textarea class="form-control" id="notes" name="notes" rows="2" 
                          placeholder="Enter any notes / ใส่หมายเหตุ"></textarea>
            </div>
            
            <div class="mb-3">
                <label for="terms_conditions" class="form-label">Terms & Conditions / ข้อตกลงและเงื่อนไข</label>
                <textarea class="form-control" id="terms_conditions" name="terms_conditions" rows="3" 
                          placeholder="Enter terms and conditions / ใส่ข้อตกลงและเงื่อนไข"></textarea>
            </div>
            
            <!-- Product Selection -->
            <h5 class="mb-3">Products / สินค้า</h5>
            <div class="table-responsive">
                <table class="table table-bordered" id="quotation-items">
                    <thead>
                        <tr>
                            <th>Product / สินค้า</th>
                            <th>Quantity / จำนวน</th>
                            <th>Unit Price / ราคาต่อหน่วย</th>
                            <th>Discount / ส่วนลด</th>
                            <th>Total / รวม</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="item-row">
                            <td>
                                <select class="form-select product-select" name="product_id[]" required>
                                    <option value="">Select Product / เลือกสินค้า</option>
                                    {% for product in products %}
                                    <option value="{{ product.id }}" data-price="{{ product.unit_price }}">
                                        {{ product.name }} - ฿{{ "{:,.2f}".format(product.unit_price) }} (Stock: {{ product.stock_quantity }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="number" class="form-control quantity-input" name="quantity[]" 
                                       min="1" value="1" required>
                            </td>
                            <td>
                                <input type="number" class="form-control price-input" name="unit_price[]" 
                                       step="0.01" min="0" required>
                            </td>
                            <td>
                                <input type="number" class="form-control discount-input" name="item_discount[]" 
                                       step="0.01" min="0" max="100" value="0">
                            </td>
                            <td>
                                <span class="total-display">฿0.00</span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-row">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <button type="button" class="btn btn-outline-primary mb-3" id="add-row">
                <i class="fas fa-plus me-2"></i>Add Item / เพิ่มรายการ
            </button>
            
            <!-- Totals -->
            <div class="row">
                <div class="col-md-8"></div>
                <div class="col-md-4">
                    <table class="table table-sm">
                        <tr>
                            <td>Subtotal / ยอดรวม:</td>
                            <td class="text-end" id="subtotal">฿0.00</td>
                        </tr>
                        <tr>
                            <td>Discount / ส่วนลด:</td>
                            <td class="text-end" id="discount-amount">฿0.00</td>
                        </tr>
                        <tr>
                            <td>Tax (7%) / ภาษี (7%):</td>
                            <td class="text-end" id="tax-amount">฿0.00</td>
                        </tr>
                        <tr class="table-primary">
                            <td><strong>Total / รวมสุทธิ:</strong></td>
                            <td class="text-end"><strong id="grand-total">฿0.00</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" onclick="history.back()">Cancel / ยกเลิก</button>
                <button type="submit" class="btn btn-primary">Save Quotation / บันทึกใบเสนอราคา</button>
            </div>
        </form>
    </div>
</div>

<script>
// Add new row functionality
document.getElementById('add-row').addEventListener('click', function() {
    const tbody = document.querySelector('#quotation-items tbody');
    const firstRow = tbody.querySelector('.item-row');
    const newRow = firstRow.cloneNode(true);
    
    // Clear input values
    newRow.querySelectorAll('input, select').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantity') ? '1' : '0';
        } else {
            input.value = '';
        }
    });
    newRow.querySelector('.total-display').textContent = '฿0.00';
    
    tbody.appendChild(newRow);
    attachRowEvents(newRow);
});

// Remove row functionality
function attachRowEvents(row) {
    row.querySelector('.remove-row').addEventListener('click', function() {
        const tbody = document.querySelector('#quotation-items tbody');
        if (tbody.children.length > 1) {
            row.remove();
            calculateTotal();
        }
    });
    
    // Product selection change
    row.querySelector('.product-select').addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        const price = option.getAttribute('data-price');
        if (price) {
            row.querySelector('.price-input').value = price;
            calculateRowTotal(row);
        }
    });
    
    // Quantity, price, discount change
    row.querySelectorAll('.quantity-input, .price-input, .discount-input').forEach(input => {
        input.addEventListener('input', function() {
            calculateRowTotal(row);
        });
    });
}

// Calculate row total
function calculateRowTotal(row) {
    const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
    const price = parseFloat(row.querySelector('.price-input').value) || 0;
    const discount = parseFloat(row.querySelector('.discount-input').value) || 0;
    
    const subtotal = quantity * price;
    const discountAmount = subtotal * (discount / 100);
    const total = subtotal - discountAmount;
    
    row.querySelector('.total-display').textContent = '฿' + total.toLocaleString('en-US', {minimumFractionDigits: 2});
    calculateTotal();
}

// Calculate grand total
function calculateTotal() {
    let subtotal = 0;
    document.querySelectorAll('.item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
        const price = parseFloat(row.querySelector('.price-input').value) || 0;
        const discount = parseFloat(row.querySelector('.discount-input').value) || 0;
        
        const rowSubtotal = quantity * price;
        const discountAmount = rowSubtotal * (discount / 100);
        subtotal += (rowSubtotal - discountAmount);
    });
    
    const overallDiscount = parseFloat(document.getElementById('discount').value) || 0;
    const discountAmount = subtotal * (overallDiscount / 100);
    const afterDiscount = subtotal - discountAmount;
    const taxAmount = afterDiscount * 0.07;
    const grandTotal = afterDiscount + taxAmount;
    
    document.getElementById('subtotal').textContent = '฿' + subtotal.toLocaleString('en-US', {minimumFractionDigits: 2});
    document.getElementById('discount-amount').textContent = '฿' + discountAmount.toLocaleString('en-US', {minimumFractionDigits: 2});
    document.getElementById('tax-amount').textContent = '฿' + taxAmount.toLocaleString('en-US', {minimumFractionDigits: 2});
    document.getElementById('grand-total').textContent = '฿' + grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2});
}

// Overall discount change
document.getElementById('discount').addEventListener('input', calculateTotal);

// Initialize events for existing rows
document.querySelectorAll('.item-row').forEach(attachRowEvents);
</script>
{% endblock %}